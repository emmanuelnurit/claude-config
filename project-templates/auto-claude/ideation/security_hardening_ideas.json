{
  "security_hardening": [
    {
      "id": "sec-001",
      "type": "security_hardening",
      "title": "Fix insecure cookie attributes on authentication cookies",
      "description": "In AuthController.php (lines 239-241 and 251), cookies are created with `Secure=false` and `HttpOnly=false`. The remember-me cookie specifically has `HttpOnly=false`, making it accessible to JavaScript and vulnerable to XSS-based theft. The cart cookie also uses `Secure=false`, allowing transmission over unencrypted HTTP connections.",
      "rationale": "Insecure cookie attributes expose authentication tokens to theft via XSS attacks and man-in-the-middle attacks. Session hijacking can lead to complete account takeover, allowing attackers to impersonate users, access their orders, payment information, and personal data.",
      "category": "authentication",
      "severity": "high",
      "affectedFiles": [
        "src/Api/AuthController.php",
        "src/EventSubscriber/CartCookieSubscriber.php"
      ],
      "vulnerability": "CWE-614: Sensitive Cookie in HTTPS Session Without 'Secure' Attribute, CWE-1004: Sensitive Cookie Without 'HttpOnly' Flag",
      "currentRisk": "Authentication and cart cookies can be stolen via XSS or intercepted over HTTP connections, enabling session hijacking",
      "remediation": "Set `Secure=true` for all cookies when the application is served over HTTPS. Set `HttpOnly=true` for authentication-related cookies (remember-me, session). Add `SameSite=Lax` or `SameSite=Strict` attribute to prevent CSRF attacks via cookies. Update Cookie::create() calls to use secure defaults.",
      "references": [
        "https://owasp.org/www-community/controls/SecureCookieAttribute",
        "https://cheatsheetseries.owasp.org/cheatsheets/Session_Management_Cheat_Sheet.html"
      ],
      "compliance": ["PCI-DSS", "GDPR"]
    },
    {
      "id": "sec-002",
      "type": "security_hardening",
      "title": "Add CSRF protection to authentication API endpoints",
      "description": "The login endpoint (`/moderna-api/auth/login`), registration endpoint (`/moderna-api/register`), and wishlist endpoints (`/moderna-api/wishlist/*`) lack CSRF token validation. While address and customer update forms properly implement CSRF protection via `csrf_token()`, the JSON API endpoints for authentication are unprotected.",
      "rationale": "Without CSRF protection, attackers can craft malicious pages that submit login/registration requests on behalf of authenticated users. This enables login CSRF attacks where victims are logged into attacker-controlled accounts, potentially exposing their activities. For wishlist endpoints, attackers could manipulate user wishlists.",
      "category": "authorization",
      "severity": "high",
      "affectedFiles": [
        "src/Api/AuthController.php",
        "src/Api/RegistrationController.php",
        "src/Api/WishlistController.php",
        "login.html.twig",
        "register.html.twig"
      ],
      "vulnerability": "CWE-352: Cross-Site Request Forgery (CSRF)",
      "currentRisk": "Attackers can perform login CSRF attacks to associate victims with attacker accounts, or manipulate wishlists without user consent",
      "remediation": "Implement CSRF token validation on all state-changing API endpoints. For SPA/AJAX requests, use the Double Submit Cookie pattern or include a CSRF token from the session in request headers. Add `csrf_token()` generation in templates and validate using `$this->isCsrfTokenValid()` in controllers. Consider using Symfony's CSRF protection bundle for consistent implementation.",
      "references": [
        "https://owasp.org/www-community/attacks/csrf",
        "https://symfony.com/doc/current/security/csrf.html",
        "https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html"
      ],
      "compliance": ["OWASP Top 10"]
    },
    {
      "id": "sec-003",
      "type": "security_hardening",
      "title": "Implement rate limiting on authentication endpoints",
      "description": "The login (`/moderna-api/auth/login`), registration (`/moderna-api/register`), and forgot-password (`/moderna-api/auth/forgot-password`) endpoints have no rate limiting implementation. There are no checks for repeated failed login attempts or protection against automated registration abuse.",
      "rationale": "Without rate limiting, attackers can perform brute-force password attacks at scale, credential stuffing attacks using leaked credential databases, and automated account creation for spam or abuse. The forgot-password endpoint could be abused for email flooding attacks against users.",
      "category": "authentication",
      "severity": "high",
      "affectedFiles": [
        "src/Api/AuthController.php",
        "src/Api/RegistrationController.php"
      ],
      "vulnerability": "CWE-307: Improper Restriction of Excessive Authentication Attempts",
      "currentRisk": "Account compromise via brute-force attacks, credential stuffing from data breaches, and abuse of registration system for spam",
      "remediation": "Implement rate limiting using Symfony's RateLimiter component. Apply limits per IP and per account for login attempts (e.g., 5 attempts per minute, progressive lockout). Add CAPTCHA verification after failed attempts. For registration, limit requests per IP (e.g., 3 accounts per hour). Track failed login attempts in database and implement temporary account lockout. Add rate limiting to forgot-password endpoint.",
      "references": [
        "https://owasp.org/www-community/controls/Blocking_Brute_Force_Attacks",
        "https://symfony.com/doc/current/rate_limiter.html",
        "https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html"
      ],
      "compliance": ["PCI-DSS", "SOC2"]
    },
    {
      "id": "sec-004",
      "type": "security_hardening",
      "title": "Sanitize user-generated content rendered with |raw filter to prevent stored XSS",
      "description": "Multiple Twig templates use the `|raw` filter to render content that could contain user or admin input: category descriptions (`category.html.twig:40`), product descriptions (`product.html.twig:375`), and wishlist HTML attributes (`ProductCard.html.twig:45`). While this content typically comes from admin-entered data, stored XSS is possible if any admin account is compromised or if the data source is not properly validated on input.",
      "rationale": "Stored XSS vulnerabilities allow attackers to inject malicious JavaScript that executes in victims' browsers when viewing affected pages. This can lead to session hijacking, credential theft, phishing, and malware distribution. In an e-commerce context, attackers could steal payment information or redirect users to malicious sites.",
      "category": "input_validation",
      "severity": "medium",
      "affectedFiles": [
        "category.html.twig",
        "product.html.twig",
        "src/UiComponents/Product/ProductCard.html.twig"
      ],
      "vulnerability": "CWE-79: Improper Neutralization of Input During Web Page Generation (Cross-site Scripting)",
      "currentRisk": "Stored XSS if admin accounts are compromised or if CMS content is not properly sanitized on input, potentially affecting all site visitors",
      "remediation": "Implement a whitelist-based HTML sanitizer for rich content fields. Use a library like HTMLPurifier or Symfony's HtmlSanitizer component to strip dangerous tags and attributes while preserving safe formatting. Apply sanitization on both input (when saving to database) and output (as defense in depth). For attributes like `wishlistAttributesHtml`, escape individual values and construct HTML programmatically rather than rendering raw HTML strings.",
      "references": [
        "https://owasp.org/www-community/attacks/xss/",
        "https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html",
        "https://symfony.com/doc/current/html_sanitizer.html"
      ],
      "compliance": ["OWASP Top 10", "PCI-DSS"]
    },
    {
      "id": "sec-005",
      "type": "security_hardening",
      "title": "Remove exception message exposure from API error responses",
      "description": "Multiple API controllers expose internal exception messages directly in HTTP responses. In DataController.php (lines 69, 111, 164) and other controllers, error responses include `'message' => $e->getMessage()`, potentially leaking sensitive implementation details, database structure, or file paths to attackers.",
      "rationale": "Detailed error messages help attackers understand the application's internal structure, identify vulnerable components, and craft targeted attacks. Exception messages may reveal database table names, SQL queries, file paths, or third-party service configurations. This information disclosure aids reconnaissance for more sophisticated attacks.",
      "category": "configuration",
      "severity": "medium",
      "affectedFiles": [
        "src/Api/DataController.php",
        "src/Api/AuthController.php",
        "src/Api/WishlistController.php"
      ],
      "vulnerability": "CWE-209: Generation of Error Message Containing Sensitive Information",
      "currentRisk": "Attackers can gather internal implementation details, database structure, and infrastructure information through error messages to plan targeted attacks",
      "remediation": "Return generic error messages to users while logging detailed exceptions server-side. Create a centralized exception handler that: (1) logs full exception details with stack traces for debugging, (2) returns user-friendly generic messages like 'An error occurred, please try again', (3) includes a unique error ID for correlation. In production, ensure `APP_ENV=prod` disables debug mode. Implement structured logging with correlation IDs for troubleshooting without exposing details to users.",
      "references": [
        "https://owasp.org/www-community/Improper_Error_Handling",
        "https://cheatsheetseries.owasp.org/cheatsheets/Error_Handling_Cheat_Sheet.html"
      ],
      "compliance": ["OWASP Top 10", "SOC2"]
    }
  ],
  "metadata": {
    "dependenciesScanned": 48,
    "knownVulnerabilities": 0,
    "filesAnalyzed": 35,
    "criticalIssues": 0,
    "highIssues": 3,
    "mediumIssues": 2,
    "lowIssues": 0,
    "generatedAt": "2026-01-09T14:30:00Z",
    "analysisScope": "Moderna frontOffice template for Thelia 3",
    "notesOnDependencies": "All npm dependencies are standard build/development tools (Webpack, PostCSS, Tailwind, Alpine.js). No known CVEs detected in direct dependencies. Run 'npm audit' for detailed vulnerability scan."
  }
}
