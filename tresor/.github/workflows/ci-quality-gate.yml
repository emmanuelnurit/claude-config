---
name: CI Quality Gate

'on':
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:
    inputs:
      ref:
        description: Branch to run quality gate against
        required: false
  repository_dispatch:
    types: [ci-quality]

concurrency:
  group: quality-gate-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

jobs:
  quality:
    name: Lint, Tests, Docs, Security
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 25
    steps:
      - name: Resolve ref
        id: ref
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ github.event.inputs.ref }}" ]]; then
            echo "target_ref=${{ github.event.inputs.ref }}" >> "$GITHUB_OUTPUT"
          elif [[ "${{ github.event_name }}" == "repository_dispatch" && -n "${{ github.event.client_payload.ref }}" ]]; then
            echo "target_ref=${{ github.event.client_payload.ref }}" >> "$GITHUB_OUTPUT"
          else
            echo "target_ref=${{ github.head_ref || github.ref_name }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ steps.ref.outputs.target_ref }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install tooling
        run: |
          python -m pip install --upgrade pip
          pip install yamllint==1.35.1 check-jsonschema==0.28.4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: YAML lint (.github/workflows)
        run: |
          yamllint -d '{extends: default, rules: {line-length: {max: 160}}}' .github/workflows

      - name: Validate GitHub workflow schemas
        run: |
          # Exclude smart-sync.yml (uses projects_v2_item event not in standard schema)
          for file in .github/workflows/*.yml; do
            if [[ "$file" != *"smart-sync.yml" ]]; then
              check-jsonschema --builtin-schema github-workflows "$file"
            fi
          done

      - name: Check SKILL.md YAML frontmatter
        run: |
          echo "Checking SKILL.md files for valid YAML frontmatter..."
          find skills -name "SKILL.md" | while read -r file; do
            echo "Validating: $file"
            # Extract YAML frontmatter between --- markers
            awk '/^---$/{i++; next} i==1' "$file" > /tmp/skill-yaml.txt
            if [ -s /tmp/skill-yaml.txt ]; then
              python -c "import yaml; yaml.safe_load(open('/tmp/skill-yaml.txt'))" || {
                echo "::error file=$file::Invalid YAML frontmatter"
                exit 1
              }
            fi
          done

      - name: Check agent .md YAML frontmatter
        run: |
          echo "Checking agent .md files for valid YAML frontmatter..."
          find agents -name "*.md" -not -name "README.md" | while read -r file; do
            echo "Validating: $file"
            # Extract YAML frontmatter between --- markers
            awk '/^---$/{i++; next} i==1' "$file" > /tmp/agent-yaml.txt
            if [ -s /tmp/agent-yaml.txt ]; then
              python -c "import yaml; yaml.safe_load(open('/tmp/agent-yaml.txt'))" || {
                echo "::error file=$file::Invalid YAML frontmatter"
                exit 1
              }
            fi
          done

      # - name: Markdown link spot-check
      #   run: |
      #     npx --yes markdown-link-check@3.12.2 README.md
      # Note: Disabled due to external link issues (LinkedIn 999, GitHub Discussions 404)
      # Re-enable after fixing or configuring to skip external links

      - name: Summarize results
        if: always()
        run: |
          echo "Quality gate completed with status: ${{ job.status }}"
